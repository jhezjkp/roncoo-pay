# 龙果支付系统

##开发工具

 eclipse、git或svn、maven



## 技术框架

​    核心框架：Spring Framework 3.2.4

​    持久化框架：MyBatis 3.4.

​    安全框架：Apache Shiro 1.2.5

​    日志管理：SLF4J 1.7.21、Log4j 1.2.17

​    数据库连接池：Druid 1.0.19    

​    消息总线：ActiveMQ 5.11.4

​    工具包：fastjson 1.2.11 

​    jQuery 框架：DWZ





##  系统运行环境

### 软件环境：

​        MySQL

​        JDK1.7或以上，需要安装[JCE1.7](https://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html)

​        apache-tomcat-7.0或其他容器

​        ActiveMQ 5.11

### 硬件环境(最小配置)：

​        CPU：1核

​        内存：1G



## 安装部署

### 说明

​        运营管理系统登录账号密码：admin/123456

​        商户后台系统登录账号密码：在boss运营后台添加用户时录入手机和密码

​        roncoo-pay-common-core：公共类工程，不用单独部署

​        roncoo-pay-service：核心业务类工程，不用单独部署

​        roncoo-pay-app-notify：通知应用工程，独立jar方式启动

​        roncoo-pay-app-reconciliation：对账应用工程，独立jar方式启动

​        roncoo-pay-app-settlement：结算应用工程，独立jar方式启动

​        roncoo-pay-web-boss：运营管理后台，部署tomcat启动

​        roncoo-pay-web-gateway：支付网关工程，部署tomcat启动

​        roncoo-pay-web-sample-shop：模拟商城工程，部署tomcat启动

​        roncoo-pay-web-merchant：商户后台工程，部署tomcat启动

### 步骤

1. 创建数据库，导入初始化脚本database.sql

2. 修改系统数据库连接roncoo-pay-service/src/main/resources/jdbc.properties

3. 从roncoo-pay-service工程的lib文件夹下加载支付宝支付sdk“alipay-sdk-java20151021120052.jar”和

   ​  “alipay-trade-sdk.jar”

4. 下载ActiveMQ 5.11并安装，修改MQ配置roncoo-pay-service/src/main/resources/ mq_config.properties，

   以独立jar方式启动roncoo-pay-app-notify工程

   （注：商户通知是独立的一块，不影响支付及其他功能，可以省略该步骤)

5. 以独立jar方式启动roncoo-pay-app-settlement工程

6. 修改对账文件下载后存放地址roncoo-pay-service/src/main/resources/reconciliation_config.properties，

   以独立jar方式启动roncoo-pay-app-reconciliation

7. 添加支付宝和微信测试账号信息roncoo-pay-service/src/main/resources/alipay_config.properties

   和weixinpay_config

   (注：不需要本地测试支付，可以省略该步骤)

8. 通过mvn install命令打包编译系统

9. 拷贝roncoo-pay-web-boss.war、roncoo-pay-web-gateway.war、roncoo-pay-web-sample-shop.war、roncoo-pay-web-merchant.war至tomcat启动

## FAQ

1. 商户平台报`com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Expression #2 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'roncoo_pay.rp_trade_payment_record.create_time' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by`异常怎么办？

   检查mysql版本是5.7，如果是则需要运行一个sql`set @@sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';`，详情参考[这里](https://blog.csdn.net/lm409/article/details/73065217)

## 文档链接

开源中国地址：<http://www.oschina.net/p/roncoo-pay>

<http://git.oschina.net/roncoocom/roncoo-pay>

GitHub地址：<https://github.com/roncoo/roncoo-pay>

在线支付演示：[http://demo.pay.roncoo.com](http://demo.pay.roncoo.com/)
后台运营管理：<http://demo.pay.roncoo.com/boss>
系统操作说明：<http://www.roncoo.com/article/detail/124375>
系统详细介绍：<http://www.roncoo.com/article/detail/124373>
系统搭建部署：<http://www.roncoo.com/article/detail/124511>



网友分析：

https://segmentfault.com/a/1190000014534777



支付宝扫码支付流程：https://openclub.alipay.com/read.php?tid=1692&fid=6

支付宝网站接入流程：https://docs.open.alipay.com/270/105899/

## 业务流程分析

+ gateway创建订单后，通过mq向pooling发送一条通知，让他开始pooling

## 其他

接入activemq安装与启动，默认管理地址为<http://localhost:8161/>，默认用户名密码均为admin

```shell
brew install activemq
activemq start
```

支付宝沙箱环境配置帮助：http://docs.xxpay.org/docs/deploy/41

回调环境需要开放vps与本地的frp做内网穿透

## 运营平台手册

添加商户：用户管理->添加用户



